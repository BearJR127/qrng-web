<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QRNG Web Portal</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; color: #333; text-align: center; padding: 20px; }
    button, select { padding: 10px 20px; margin: 10px; font-size: 16px; }
    #result { font-size: 20px; margin-top: 20px; }
    .match { color: lime; font-weight: bold; }
    .no-match { color: red; font-weight: bold; }
    .premonition-choice { margin: 5px; }
    #premonition-inputs { margin-top: 10px; }
    canvas { background: #222; border: 1px solid #444; margin-top: 20px; }
    #chart { background: #fff; }
    #live-container { position: relative; display: flex; justify-content: center; gap: 20px; }
    #dashboard-stats { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.8); padding: 4px 8px; border-radius: 4px; font-size: 14px; line-height: 1.2; text-align: right; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.4/jstat.min.js"></script>
</head>
<body>
  <h1>Quantum RNG Web Portal</h1>

  <div>
    <label>Username:</label>
    <input type="text" id="username" value="unidentified" />
  </div>

  <div>
    <label>Email:</label>
    <input type="email" id="email" value="unidentified" />
  </div>

  <div>
    <label>Select Mode:</label>
    <select id="mode">
      <option value="focus">Focus</option>
      <option value="guesser">Guesser</option>
      <option value="premonition">Premonition</option>
    </select>
  </div>

  <div>
    <label>RNG:</label>
    <select id="rng">
      <option value="camera" selected>Camera</option>
      <option value="event">Software</option>
    </select>
  </div>

  <div id="single-choice-container">
    <label>Select a Symbol:</label>
    <select id="single-choice">
      <option value="Red">Red</option>
      <option value="Blue">Blue</option>
      <option value="Green">Green</option>
      <option value="Yellow">Yellow</option>
    </select>
  </div>

  <div id="premonition-inputs" style="display:none;">
    <label>Select 5 Symbols:</label><br>
    <select class="premonition-choice" id="user-choice-1">
      <option value="Red">Red</option>
      <option value="Blue">Blue</option>
      <option value="Green">Green</option>
      <option value="Yellow">Yellow</option>
    </select>
    <select class="premonition-choice" id="user-choice-2">
      <option value="Red">Red</option>
      <option value="Blue">Blue</option>
      <option value="Green">Green</option>
      <option value="Yellow">Yellow</option>
    </select>
    <select class="premonition-choice" id="user-choice-3">
      <option value="Red">Red</option>
      <option value="Blue">Blue</option>
      <option value="Green">Green</option>
      <option value="Yellow">Yellow</option>
    </select>
    <select class="premonition-choice" id="user-choice-4">
      <option value="Red">Red</option>
      <option value="Blue">Blue</option>
      <option value="Green">Green</option>
      <option value="Yellow">Yellow</option>
    </select>
    <select class="premonition-choice" id="user-choice-5">
      <option value="Red">Red</option>
      <option value="Blue">Blue</option>
      <option value="Green">Green</option>
      <option value="Yellow">Yellow</option>
    </select>
  </div>

  <button onclick="runTrial()" id="trial-button">Start Trial</button>
  <button onclick="exportCSV()">Export CSV</button>

  <div id="result"></div>
  <div id="live-container">
    <div id="dashboard-stats"></div>
    <canvas id="chart" width="320" height="240"></canvas>
    <video id="video" width="320" height="240" autoplay muted></video>
  </div>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // TODO: fill in your Firebase config
    const firebaseConfig = {
      apiKey: "",
      authDomain: "",
      projectId: "",
      storageBucket: "",
      messagingSenderId: "",
      appId: ""
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const SYMBOLS = ["Red","Blue","Green","Yellow"];
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let premonitionStats = {round:0,totalMatches:0,totalTrials:0};
    let chartInstance = null;
    let focusRunning = false;

    function updateChart(snapshot) {
      const data = {Red:0,Blue:0,Green:0,Yellow:0},
            total = {Red:0,Blue:0,Green:0,Yellow:0};
      snapshot.forEach(d => {
        const e = d.data();
        if(e.userSymbol in total){
          total[e.userSymbol]++;
          if(e.match) data[e.userSymbol]++;
        }
      });
      const labels = SYMBOLS.slice(),
            matches = labels.map(s=>data[s]),
            attempts = labels.map(s=>total[s]);
      const allMatches = matches.reduce((a,b)=>a+b,0);
      const allAttempts = attempts.reduce((a,b)=>a+b,0);
      labels.push('All');
      const datasetData = SYMBOLS.map((_,i)=>attempts[i]?((matches[i]/attempts[i])*100):0);
      datasetData.push(allAttempts?((allMatches/allAttempts)*100):0);
      if(chartInstance) chartInstance.destroy();
      const ctxc = document.getElementById('chart').getContext('2d');
      chartInstance = new Chart(ctxc, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Match %', data:datasetData, backgroundColor:['red','blue','green','yellow','gray'] }]},
        options:{ scales:{ y:{ beginAtZero:true, max:100 } } }
      });
      document.getElementById('dashboard-stats').innerText = `Matched: ${allMatches}\nTrials: ${allAttempts}`;
    }

    function initLiveDashboard(){
      onSnapshot(collection(db, 'qrng_trials'), snap => updateChart(snap));
    }
    function updateUIForMode() {
      const m = document.getElementById("mode").value;
      document.getElementById("single-choice-container").style.display = m === "premonition" ? "none" : "block";
      document.getElementById("premonition-inputs").style.display = m === "premonition" ? "block" : "none";
    }
    document.getElementById("mode").addEventListener("change", updateUIForMode);
    updateUIForMode();
    initLiveDashboard();

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; })
      .catch(err => { document.getElementById("result").innerText = "Webcam access denied."; });

    function extractRawBits(data, w, h) {
      const bits = [];
      for (let i = 0; i < 64; i++) {
        const x1 = Math.floor(Math.random() * w), y1 = Math.floor(Math.random() * h);
        const x2 = Math.floor(Math.random() * w), y2 = Math.floor(Math.random() * h);
        const idx1 = (y1 * w + x1) * 4, idx2 = (y2 * w + x2) * 4;
        const gray1 = 0.299 * data[idx1] + 0.587 * data[idx1+1] + 0.114 * data[idx1+2];
        const gray2 = 0.299 * data[idx2] + 0.587 * data[idx2+1] + 0.114 * data[idx2+2];
        bits.push((gray1 ^ gray2) & 1);
      }
      return bits;
    }

    function vonNeumann(bits) {
      const out = [];
      for (let i = 0; i < bits.length - 1; i += 2) {
        const [b1, b2] = [bits[i], bits[i+1]];
        if (b1 === 0 && b2 === 1) out.push(0);
        else if (b1 === 1 && b2 === 0) out.push(1);
      }
      return out;
    }

    function getSymbolFromWebcam() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const raw = extractRawBits(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
      const vn = vonNeumann(raw);
      if (vn.length < 2) return null;
      return SYMBOLS[parseInt(vn.slice(0,2).join(""), 2)];
    }

    function getSymbolFromEvent() {
      const arr = new Uint32Array(1);
      window.crypto.getRandomValues(arr);
      return SYMBOLS[arr[0] % SYMBOLS.length];
    }

    function getSymbol() {
      const rngMode = document.getElementById("rng").value;
      if (rngMode === 'event') {
        return getSymbolFromEvent();
      }
      return getSymbolFromWebcam();
    }

    async function singleFocusTrial(username, email) {
      const guess = document.getElementById("single-choice").value;
      const actual = getSymbol();
      if (!actual) {
        document.getElementById("result").innerText = "Insufficient random bits — try again.";
        return;
      }
      const match = (actual === guess);
      document.getElementById("result").innerHTML =
        `Your focus: <b>${guess}</b><br>` +
        `Actual: <b>${actual}</b><br>` +
        `<span class='${match?'match':'no-match'}'>${match?'✔ Match!':'✘ No match'}</span>`;
      addDoc(collection(db, 'qrng_trials'), { timestamp: new Date(), mode:'focus', userSymbol: guess, actualSymbol: actual, match, username, email })
        .catch(e => console.error(e));
    }

    function startFocusLoop(username, email) {
      focusRunning = true;
      document.getElementById('trial-button').innerText = 'Stop Trial';
      const loop = async () => {
        if (!focusRunning) return;
        await singleFocusTrial(username, email);
        setTimeout(loop, 200);
      };
      loop();
    }

    function stopFocusLoop() {
      focusRunning = false;
      document.getElementById('trial-button').innerText = 'Start Trial';
    }

    async function runTrial() {
      const mode = document.getElementById("mode").value;
      const username = document.getElementById("username").value.trim() || 'unidentified';
      const email = document.getElementById("email").value.trim() || 'unidentified';
      if (mode === 'focus') {
        if (focusRunning) {
          stopFocusLoop();
        } else {
          startFocusLoop(username, email);
        }
        return;
      }
      if (mode === 'premonition') {
        const guesses = [];
        for (let i = 1; i <= 5; i++) {
          guesses.push(document.getElementById(`user-choice-${i}`).value);
        }
        const results = [];
        for (const guess of guesses) {
          const actual = getSymbol();
          if (!actual) {
            document.getElementById("result").innerText = "Insufficient random bits — try again.";
            return;
          }
          const match = (actual === guess);
          results.push({ guess, actual, match });
          addDoc(collection(db, 'qrng_trials'), { timestamp: new Date(), mode, userSymbol: guess, actualSymbol: actual, match, username, email })
            .catch(e => console.error(e));
        }
        let summary = '';
        let matchCount = 0;
        results.forEach((r,i) => {
          if (r.match) matchCount++;
          summary += `Guess ${i+1}: <b>${r.guess}</b> | Actual: <b>${r.actual}</b> - <span class='${r.match?'match':'no-match'}'>${r.match?'✔':'✘'}</span><br>`;
        });
        premonitionStats.round++;
        premonitionStats.totalMatches += matchCount;
        premonitionStats.totalTrials += 5;
        summary += `<b>Round ${premonitionStats.round}: ${matchCount}/5 correct</b><br>`;
        document.getElementById("result").innerHTML = summary;
        document.querySelectorAll('.premonition-choice').forEach(sel => sel.selectedIndex = 0);
        return;
      }

      let guess, actual;
      if (mode === 'guesser') {
        actual = getSymbol();
        if (!actual) {
          document.getElementById("result").innerText = "Insufficient random bits — try again.";
          return;
        }
        guess = document.getElementById("single-choice").value;
      } else {
        guess = document.getElementById("single-choice").value;
        actual = getSymbol();
        if (!actual) {
          document.getElementById("result").innerText = "Insufficient random bits — try again.";
          return;
        }
      }
      const match = (actual === guess);
      document.getElementById("result").innerHTML =
        `Your ${mode==='focus'?'focus':'guess'}: <b>${guess}</b><br>
         Actual: <b>${actual}</b><br>
         <span class='${match?'match':'no-match'}'>${match?'✔ Match!':'✘ No match'}</span>`;
      addDoc(collection(db, 'qrng_trials'), { timestamp: new Date(), mode, userSymbol: guess, actualSymbol: actual, match, username, email })
        .catch(e => console.error(e));
    }

    async function exportCSV() {
      const modeFilter = prompt("Filter (focus, guesser, premonition) or leave blank:").toLowerCase();
      const snap = await getDocs(collection(db, 'qrng_trials'));
      const data = {Red:0,Blue:0,Green:0,Yellow:0}, total={Red:0,Blue:0,Green:0,Yellow:0}, rows=[];
      snap.forEach(d => {
        const e = d.data();
        if (modeFilter && e.mode !== modeFilter) return;
        if (e.userSymbol in total) {
          total[e.userSymbol]++;
          if (e.match) data[e.userSymbol]++;
          let ts = '';
          if (e.timestamp) {
            const dt = e.timestamp.toDate ? e.timestamp.toDate() : new Date(e.timestamp);
            ts = dt.toISOString().replace('T', ' ').split('.')[0];
          }
          rows.push([ts, e.username || '', e.email || '', e.mode, e.userSymbol, e.actualSymbol, e.match]);
        }
      });
      const labels = SYMBOLS;
      const matches = labels.map(s=>data[s]);
      const attempts = labels.map(s=>total[s]);
      const p0 = 1/4, z = jStat.normal.inv(0.975,0,1);
      const stats = labels.map((s,i)=>{
        const n=attempts[i], k=matches[i];
        const rate=n?((k/n)*100).toFixed(1):0;
        const se0=Math.sqrt(p0*(1-p0)/n), delta=(k/n)-p0, mu=delta/se0;
        const power=n?((jStat.normal.cdf(-z-mu)+1-jStat.normal.cdf(z-mu)).toFixed(3)):0;
        const chi = ((k-n*p0)**2/(n*p0) + ((n-k)-n*(1-p0))**2/(n*(1-p0)));
        const pval=n?(1-jStat.chisquare.cdf(chi,1)).toFixed(5):0;
        const ci = n?`±${(z*Math.sqrt((k/n)*(1-k/n)/n)*100).toFixed(1)}`:'±0';
        return {s,n,k,rate,pval,power,ci};
      });
      let csv='timestamp,username,email,mode,userSymbol,actualSymbol,match\n'+rows.map(r=>r.join(',')).join('\n')+'\n\nSymbol,N,Matches,Rate%,CI,p-value,Power\n'+stats.map(x=>`${x.s},${x.n},${x.k},${x.rate},${x.ci},${x.pval},${x.power}`).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob), a=document.createElement('a');
      a.href=url; a.download=`qrng_${modeFilter||'all'}.csv`; a.click(); URL.revokeObjectURL(url);
    }

    // Expose functions to global scope for onclick handlers
    window.runTrial = runTrial;
    window.exportCSV = exportCSV;
  </script>
  <hr>
  <p><em>Copyright 2025 BearJR127. All right reserved, any usage or modification of this software requires expressed permission.</em></p>
</body>
</html>
